# Flutter Clean Architecture - Cursor AI Rules

## üìã Project Overview

This is a Flutter project following Clean Architecture with BLoC pattern.

## üéØ Core Principles

### Architecture Layers
- **Presentation** (BLoC) ‚Üí **Business Logic** (Use Cases) ‚Üí **Data** (Repositories)
- NEVER inject Repositories directly in BLoCs - ALWAYS use Use Cases

### Required Patterns

#### 1. BLoC Structure
```dart
@injectable
class MyBloc extends Bloc<MyEvent, MyState> with SafetyNetworkMixin {
  final MyUseCase _useCase;  // Inject Use Case, NOT Repository
  
  MyBloc(this._useCase) : super(MyState.initial()) {
    on(_onEvent);  // No type parameter
    add(const MyEvent.started());  // Auto-init
  }
  
  Future<void> _onEvent(_EventType event, emit) async {  // No Emitter<State>
    await safeNetworkCall(() async {
      // API call here
    });
  }
}
```

#### 2. Event & State (Freezed)
```dart
@freezed
class MyEvent with _$MyEvent {
  const factory MyEvent.started() = _Started;
}

@freezed
class MyState with _$MyState {
  const factory MyState({
    @Default(false) bool isLoading,
  }) = _MyState;
}
```

#### 3. Page (AutoRouteWrapper)
```dart
@RoutePage()
class MyPage extends StatelessWidget implements AutoRouteWrapper {
  const MyPage({super.key});
  
  @override
  Widget wrappedRoute(BuildContext context) {
    return BlocProvider(
      create: (context) => getIt<MyBloc>(),
      child: this,
    );
  }
  
  @override
  Widget build(BuildContext context) {
    return BlocBuilder<MyBloc, MyState>(
      buildWhen: (previous, current) => /* conditions */,
      builder: (context, state) {
        return const Scaffold(/* UI */);
      },
    );
  }
}
```

## ‚úÖ MUST DO

1. **Use `@freezed` for Events and States**
2. **Use `@injectable` for BLoCs**
3. **Implement `AutoRouteWrapper` for Pages**
4. **Auto-start BLoC with `add()` in constructor**
5. **Use `buildWhen` and `listenWhen`**
6. **Inject Use Cases only (not Repositories)**
7. **Wrap API calls with `safeNetworkCall()`**
8. **Use `const` for widgets when possible**
9. **Remove `Emitter<State>` type - use `emit` only**
10. **Remove type parameters in `on<Event>()` - use `on()` only**

## ‚ùå NEVER DO

1. Don't inject Repositories in BLoCs
2. Don't skip `buildWhen`/`listenWhen`
3. Don't use `Emitter<State>` type
4. Don't use `on<Event>()` with type parameter
5. Don't add events in `wrappedRoute()`
6. Don't create separate View class (build in Page directly)
7. Don't make direct API calls without `safeNetworkCall()`
8. Don't forget `const` for static widgets

## üîß Commands

Always use FVM + Melos:

```bash
# Get dependencies
fvm dart run melos run pg

# Generate code
fvm dart run melos run brd

# Format code
fvm dart run melos run fm

# Run app
fvm flutter run --flavor dev --dart-define-from-file=configs/dev.json
```

## üìù Naming Conventions

- **Classes**: PascalCase
- **Variables/Methods**: camelCase
- **Files**: snake_case
- **Constants**: UPPER_SNAKE_CASE
- **Private**: _leadingUnderscore

## üìö Documentation

- **Rules**: See `rules/` directory
  - `rules/clean_architecture.md` - Architecture principles
  - `rules/bloc_pattern.md` - BLoC implementation
  - `rules/code_style.md` - Code formatting

- **Docs**: See `docs/` directory
  - `docs/QUICK_START.md` - Getting started
  - `docs/SCREEN_TEMPLATE.md` - Feature template
  - `docs/COMMANDS.md` - Command reference

## üé® Code Style

- Line length: 120 characters
- Indentation: 2 spaces
- Trailing commas: REQUIRED
- Format before commit: `fvm dart run melos run fm`

## üöÄ Creating New Features

1. Create BLoC files (event, state, bloc)
2. Create Page with AutoRouteWrapper
3. Add route to `app_router.dart`
4. Run: `fvm dart run melos run brd`
5. Format: `fvm dart run melos run fm`

**IMPORTANT**: 
- `AppRouter` must be `@singleton` for dependency injection
- `AppRouter` must extend `$AppRouter` (generated class), not `RootStackRouter`

See `docs/SCREEN_TEMPLATE.md` for complete template.

## üîç Quick Checklist

When creating a new screen:
- [ ] Event uses `@freezed`
- [ ] State uses `@freezed`
- [ ] BLoC uses `@injectable`
- [ ] BLoC extends with `SafetyNetworkMixin`
- [ ] BLoC auto-starts with `add()` in constructor
- [ ] Page implements `AutoRouteWrapper`
- [ ] Page uses `@RoutePage()` annotation
- [ ] BlocBuilder has `buildWhen`
- [ ] BlocListener has `listenWhen`
- [ ] Uses `emit` instead of `Emitter<State>`
- [ ] Uses `on()` instead of `on<Event>()`
- [ ] Inject Use Case (not Repository)
- [ ] All widgets use `const` where possible

## üìñ References

- Full rules: `rules/README.md`
- Full docs: `docs/README.md`
- Template: `docs/SCREEN_TEMPLATE.md`
